{% load widget_tweaks %}

{% comment %}{% if more_back %}
    <a href="{{ request.path }}?interval={{ interval }}&from={{ back_from }}">Earlier Messages</a>
{% endif %}{% endcomment %}

{% comment %}{% if from != 0 %}
    <a href="{{ request.path }}?interval={{ interval }}&from={{ forward_from }}">Later Messages</a>
{% endif %}{% endcomment %}

{% if user.is_anonymous %}
    {{ user_anonymous_message }}
{% elif user not in members %}
    {{ not_member_message }}
{% else %}
    {% if direct %}


        <form hx-post="{{ message_post_url }}"
              hx-target="#messages"
              hx-swap="beforeend"
              enctype="multipart/form-data"
              class="p-4.5 m-0 sticky bottom-0 bottom-4.5 backdrop-blur-sm bg-[linear-gradient(180deg,_#F2000000_1%,_#FFFFFF_25%)] sm:w-[360px]">
            {% csrf_token %}

            <div class="text-meta invisible max-w-full h-0">
                {% render_field form.image %}
            </div>

            <div class="flex w-full max-w-full items-center">
                <div class="">
                    {% comment %}
                        Note that this only provides a hint to the browser as to what file-types to display to the user,
                        but this can be easily circumvented, so you should always validate the uploaded file on the server also.
                    {% endcomment %}

                    <label class="cursor-pointer" for="id_image">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 2V16H2V2H16ZM16 0H2C0.9 0 0 0.9 0 2V16C0 17.1 0.9 18 2 18H16C17.1 18 18 17.1 18 16V2C18 0.9 17.1 0 16 0ZM11.14 8.86L8.14 12.73L6 10.14L3 14H15L11.14 8.86Z"
                                  fill="#9759FF"/>
                        </svg>
                    </label>

                </div>

                {% include "partials/horizontal-spacer.html" with space="1.5" %}

                <div class="w-full">
                    <textarea data-expandable
                              class="input-text h-[50px] max-h-[150px] bg-yellow rounded-xl w-full max-w-full"
                              name=text></textarea>

                    {% comment %}            <textarea name=message></textarea>
                                <input type="file" id="image" name="image">{% endcomment %}

                    <button type="submit" class="absolute bottom-[34px] right-8">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 8L1.41 9.41L7 3.83V16H9V3.83L14.58 9.42L16 8L8 0L0 8Z" fill="#9759FF"/>
                        </svg>
                    </button>
                </div>
            </div>

        </form>
    {% else %}
        <form hx-post="{{ message_post_url }}"
              hx-target="#messages"
              enctype="multipart/form-data"
              class="p-4.5 m-0 sticky bottom-0 bottom-4.5 backdrop-blur-sm bg-[linear-gradient(180deg,_#F2000000_1%,_#FFFFFF_25%)] sm:w-[360px]">

            {% csrf_token %}
            <input type=hidden name="retrieve_messages"></input>
            {% comment %} https://stackoverflow.com/questions/1804745/get-the-filename-of-a-fileupload-in-a-document-through-javascript {% endcomment %}
            {% comment %}
            <div class="text-meta invisible max-w-full">
                {% render_field form.file %}
            </div>

            <div class="">
                <label class="cursor-pointer" for="id_file">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 2V16H2V2H16ZM16 0H2C0.9 0 0 0.9 0 2V16C0 17.1 0.9 18 2 18H16C17.1 18 18 17.1 18 16V2C18 0.9 17.1 0 16 0ZM11.14 8.86L8.14 12.73L6 10.14L3 14H15L11.14 8.86Z"
                              fill="#9759FF"/>
                    </svg>
                </label>

            </div>
            {% endcomment %}


            <div class="text-meta invisible max-w-full">
                {% render_field form.image %}
            </div>

            <div class="flex w-full max-w-full items-center">
                <div class="mr-2">
                    {% comment %}
                        Note that this only provides a hint to the browser as to what file-types to display to the user,
                        but this can be easily circumvented, so you should always validate the uploaded file on the server also.
                    {% endcomment %}

                    <label class="cursor-pointer" for="id_image">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 2V16H2V2H16ZM16 0H2C0.9 0 0 0.9 0 2V16C0 17.1 0.9 18 2 18H16C17.1 18 18 17.1 18 16V2C18 0.9 17.1 0 16 0ZM11.14 8.86L8.14 12.73L6 10.14L3 14H15L11.14 8.86Z"
                                  fill="#9759FF"/>
                        </svg>
                    </label>

                </div>
                <div class="w-full">

                    <textarea data-expandable
                              class="input-text h-[50px] max-h-[150px] bg-yellow rounded-xl w-full max-w-full"
                              name=text></textarea>

                    {% comment %}            <textarea name=message></textarea>
                                <input type="file" id="image" name="image">{% endcomment %}

                    <button type="submit" class="absolute bottom-[34px] right-8">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 8L1.41 9.41L7 3.83V16H9V3.83L14.58 9.42L16 8L8 0L0 8Z" fill="#9759FF"/>
                        </svg>

                    </button>
                </div>
            </div>

        </form>

    {% endif %}

{% endif %}

{% block scripts %}
    <script>
        {# Expandable text area need to un-JQuery this example https://codepen.io/Vanderson/pen/eYNQzdO #}
        {#$('body').on('keydown input', 'textarea[data-expandable]', function () {#}
        {#    // Auto-expanding textarea#}
        {#    this.style.removeProperty('height');#}
        {#    this.style.height = (this.scrollHeight + 2) + 'px';#}
        {# })#}
        //messages
        let messages = document.getElementById("messages")

        const observerMessages = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                for (const textInput of document.getElementsByTagName('textarea')) {
                    textInput.value = ''
                }
            })
        })
        let configMessages = {childList: true};
        observerMessages.observe(messages, configMessages);

    </script>
{% endblock %}
