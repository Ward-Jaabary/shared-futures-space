{% load static %}

{% url 'river_chat_message_count' slug stage topic as message_count_url %}
{% url 'river_chat_message_list' slug stage topic as message_list_url %}

{% block content %}

    {% if direct %}

        <div class="bg-gray-light bg-gray-light sm:w-[360px]">
            <div class="mx-4.5" x-init="">


                <div id="messages-{{ unique_id }}"
                     x-init="setTimeout(() => setupMessageRefresh(`{{ message_count_url }}`, `{{ message_list_url }}`, `messages-{{ unique_id }}`), 1000)"
                     :class="selected && 'selected'"
                >
                    {% include 'messaging/message_list.html' %}
                </div>
            </div>

            {% if chat_open %}
                {% with user_pk_string=other_user.pk|stringformat:'s' %}
                    {% with user_path=other_user.display_name|add:" "|add:user_pk_string|slugify %}
                        {% url 'user_chat' user_path as message_post_url %}
                        {% include 'messaging/chatbox_snippet.html' with direct=direct message_post_url=message_post_url %}
                    {% endwith %}
                {% endwith %}
            {% endif %}
        </div>

    {% else %}

        <div id="messages-{{ unique_id }}"
             class="mx-4.5 max-height-[50vh]"
             x-init="setTimeout(() => setupMessageRefresh(`{{ message_count_url }}`, `{{ message_list_url }}`, `messages-{{ unique_id }}`), 1000)"
             :class="selected && 'selected'"
          >
            {% include 'messaging/message_list.html' %}
        </div>
        {% if chat_open %}
            {% url 'river_chat' slug stage topic as message_post_url %}
            {% include 'messaging/chatbox_snippet.html' with direct=direct message_post_url=message_post_url %}
        {% endif %}

    {% endif %}

    <script>
        function setupMessageRefresh(messageCountURL, messageListURL, messageListTargetId) {
            let lastCount = 0

            // Get the initial value
            fetchMessageCount().then(count => {
                lastCount = count
            })

            setInterval(() => {
                if (isActive()) {
                    // We are active \o/
                    // Go and check and refresh messages if changed
                    fetchMessageCount().then(count => {
                        if (count !== lastCount) {
                            refreshMessageList()
                        }
                        lastCount = count
                    })
                }
            }, 4000)

            function fetchMessageCount() {
                return new Promise(resolve => {
                    htmx.ajax('GET', messageCountURL, {
                        handler (_, obj) {
                            const count = Number(obj.xhr.responseText)
                            resolve(count)
                        },
                    })
                })
            }

            function refreshMessageList() {
                htmx.ajax('GET', messageListURL, `#${messageListTargetId}`).then(() => {
                    const elem = document.getElementById(messageListTargetId).closest('.drawer-contents')
                    if (elem) {
                        scrollToBottom(elem)
                    }
                })
            }

            function isActive() {
                const elem = document.getElementById(messageListTargetId)
                return (
                    // Whole document is visible
                    document.visibilityState === 'visible' &&
                    // We're in a "selected" thing (defined in drawer-river)
                    elem.classList.contains('selected') &&
                    // The message list is visible (on the right tab)
                    isElementVisible(elem)
                )
            }

            function isElementVisible (elem) {
                // borrowed from jQuery logic
                return !!( elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length );
            }

            function scrollToBottom(elem) {
                elem.scrollTop = elem.scrollHeight;
            }
        }

    </script>

{% endblock %}
