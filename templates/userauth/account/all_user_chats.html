{% extends "account/base.html" %}

{% comment %} Page: messages- chat exchanges with other users /account/chat/ {% endcomment %}

{% block content %}

    {% block title %}{% include "partials/title.html" with title="Your Messages" %}{% endblock %}

    {% include "partials/vertical-spacer.html" with space="4" %}

    {% if user_chats %}
        {% for user_chat in user_chats %}
            {% with user_pk_string=user_chat.user.pk|stringformat:'s' %}
                {% with user_slug=user_chat.user.display_name|add:" "|add:user_pk_string|slugify %}

                    <a href="{% url 'user_chat' user_slug %}">
                        <div class="mx-4">
                            {% with icon_width="30px" %}
                                <div class="flex space-between items-start relative">
                                    <div class="h-[{{ icon_width }}] w-[{{ icon_width }}]">
                                        <img src="{{ user_chat.user.avatar.image_url }}" class="w-7.5 h-7.5">
                                    </div>
                                    <div class="bg-gradient-to-r from-white to-gray-light rounded-r-[50px] pl-3.5 pr-9 py-3 w-full">
                                        <h2 class="text-meta-label font-kanit-700 text-black/30">
                                            {{ user_chat.user.display_name }}
                                        </h2>
                                        {% if user_chat.latest_message %}
                                            {% include "partials/vertical-spacer.html" with space="1.5" %}
                                            <p class="text-body">
                                                {% if user_chat.latest_message.sender.display_name == "salmon" %}
                                                    {# TODO: Pull the actual system message #}
                                                    System message from The Salmon of Knowledge.
                                                {% else %}
                                                    {{ user_chat.latest_message.text|truncatechars:50 }}
                                                {% endif %}
                                            </p>
                                            {% include "partials/vertical-spacer.html" with space="1.5" %}
                                            <div class="flex gap-3">
                                                <span class="text-meta-label text-black/30">{{ user_chat.latest_message.timestamp|date:"G:i" }}</span>
                                                <span class="text-meta-label text-black/30">{{ user_chat.latest_message.timestamp|date:"d/m/y" }}</span>
                                                <span class="font-kanit-600 text-[9px] leading-3 tracking-wide text-red-important">
                                        Block {# TODO: launch block modal #}
                                    </span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endwith %}
                        </div>
                    </a>
                {% endwith %}
            {% endwith %}
            {% include "partials/vertical-spacer.html" with space="6" %}
        {% endfor %}
    {% else %}
        {% if request.user.post_code.area.name != 'Other' %}
            <div class="mx-4">
                {% url 'spring' request.user.post_code.area.name as the_url %}
                {% include "partials/salmon-of-knowledge.html" with text="No messages yet, explore rivers to find people to talk to" url=the_url button="Go to the spring" %}
            </div>
        {% endif %}
    {% endif %}

{% endblock %}
